<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <!-- 引入easyui的css 和js -->
  <link rel="stylesheet" href="./lib/jquery-easyui-1.5.5.2/themes/bootstrap/easyui.css">
  <link rel="stylesheet" href="./lib/jquery-easyui-1.5.5.2/themes/icon.css">

  <!-- jquyer -->
  <script src="./lib/jquery-easyui-1.5.5.2/jquery.min.js"></script>
  <!-- easyui的全部脚本 -->
  <script src="./lib/jquery-easyui-1.5.5.2/jquery.easyui.min.js"></script>
  <!-- 语言包 -->
  <script src="./lib/jquery-easyui-1.5.5.2/locale/easyui-lang-zh_CN.js"></script>
  <script src="./lib/template-web.js"></script>
  <title>课程列表的crud</title>

</head>

<body>
  <div class="easyui-layout" data-options="fit: true">
    <div data-options="region: 'north'">
      <input id="ss" />
      <div id="mm" style="width:120px">
        <div data-options="name:'course_name',iconCls:'icon-ok'">课程名</div>
        <div data-options="name:'college',iconCls:'icon-add'">大学</div>
      </div>
    </div>
    <div data-options="region: 'center'">
      <table id="coursett"></table>
    </div>
  </div>

  <!-- 添加课程的对话框 -->
  <div class="add-dialog" style="display: none">
    <form id="frmAdd">
      <table>
        <tr>
          <td>课程名</td>
          <td>
            <input type="text" name="course_name" id="course_name">
          </td>
        </tr>
        <tr>
          <td>作者</td>
          <td>
            <input type="text" name="author" id="author">
          </td>
        </tr>
        <tr>
          <td>大学</td>
          <td>
            <input type="text" name="college" id="college">
          </td>
        </tr>
        <tr>
          <td>分类</td>
          <td>
            <select name="category_Id" id="category_Id">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
              <option value="4">4</option>
              <option value="5">5</option>
            </select>
          </td>
        </tr>
      </table>
    </form>
  </div>

  <!-- 显示课程详细信息的对话框 -->
  <div class="info-dailog" style="display: none;">

  </div>

  <script id="showInfoDialogTmpl" type="text/html">
    <h3>课程详情</h3>
    <table>
        <tr>
          <td>课程id</td>
          <td id="cid">{{id}}</td>
        </tr>
        <tr>
          <td>课程名字</td>
          <td id="cName">{{course_name}}</td>
        </tr>
        <tr>
          <td>课程大学</td>
          <td id="cCol">{{college}}</td>
        </tr>
        <tr>
          <td>课程作者</td>
          <td id="cAut">{{author}}</td>
        </tr>
        <tr>
          <td>课程分类</td>
          <td id="cCat">{{category_Id}}</td>
        </tr>
      </table>
  </script>

  <script>
    $(function () {
      // 加载表格的数据
      initTable();

      initSearchBox();
    });

    function initSearchBox() {
      $('#ss').searchbox({
        width: 300,
        searcher: function (value, name) {
          var str = '{"' + name + '_like": "' + value + '"}';
          var param = $.parseJSON(str);
          initTable(param);
        },
        menu: '#mm',
        prompt: '请输入搜索的内容'
      });
    }

    // 加载表格的数据
    function initTable(param) {
      $('#coursett').datagrid({
        // url: '/api/course',//rows:一页有多少条，page：请求当前页
        title: '课程列表',
        fit: true,
        fitColumns: true,
        method: 'GET',  // http请求的方法
        idField: 'id',  // 主键
        loadMsg: '正在加载用户的信息...',
        pagination: true, // 是否用分页控件
        singleSelect: true, // 是否是单行选中
        pageSize: 10,  // 默认一页多少条
        pageNumber: 1, // 默认显示第几页
        pageList: [10, 20, 30],
        queryParams: param,//让表格在加载数据的时候，额外传输的数据。
        onBeforeLoad: function (param) {  // 表格控件请求之前，可以设置相关参数。
          // param = {page: 1, rows: 10}
          param._page = param.page;
          param._limit = param.rows;
          param._sort = 'id';
          param._order = 'desc';
        },
        loader: function (param, successfn, errorfn) {
          $.ajax({
            url: '/api/course',
            data: param,  // 恩国际 _page 和_limit  
            type: 'GET',
            dataType: 'json',
            success: function (resData, status, xhr) {
              var total = parseInt(xhr.getResponseHeader('X-Total-Count'));
              var datagridData = { rows: resData.data, total: total };
              successfn(datagridData);
            },
            error: errorfn
          });
        },
        onLoadSuccess: function (data) {  // 后台请求成功之后，自动调用次方法
          console.log(data);
        },
        onDblClickRow: function (rowIndex, rowData) {
          // $.messager.alert('消息', rowData.id + '', 'info');
          // $('#coursett').datagrid('beginEdit', rowIndex);
          // 弹出一个 对话框显示我们的 课程详情信息

          // 不推荐使用的方式
          // $("#cid").text(rowData.id);
          // $("#cName").text(rowData.course_name);

          // 推荐使用art-template模板，或者其他的前端模板
          var html = template('showInfoDialogTmpl', rowData);

          $('.info-dailog').dialog({
            title: '课程详情',
            content: html,
            width: 400,
            height: 300,
            modal: true,
            iconCls: 'icon-edit',
            buttons: [{
              text: '关闭',
              iconCls: 'icon-no',
              handler: function () {
                $('.info-dailog').dialog('close');
              }
            }]
          });
        },
        onBeforeEdit: function (rowIndex, rowData) {
          // 当表格进行编辑的时候，自动执行的事件
          rowData.isEditing = true; // 把当前行的数据修改
          $('#coursett').datagrid('refreshRow', rowIndex);
        },
        onCancelEdit: function (rowIndex, rowData) {
          rowData.isEditing = false; // 把当前行的数据修改
          $('#coursett').datagrid('refreshRow', rowIndex);
        },
        onEndEdit: function (rowIndex, rowData, changes) {
          rowData.isEditing = false; // 把当前行的数据修改
          $('#coursett').datagrid('refreshRow', rowIndex);
        },
        columns: [[
          { field: 'ck', checkbox: true, align: 'left', width: 50 },
          { field: 'id', title: '编号', width: 80 },
          { field: 'course_name', title: '课程名', width: 120, editor: { type: 'text', options: { required: true } } },
          { field: 'author', title: '作者', width: 120, editor: { type: 'text' } },
          { field: 'college', title: '大学', width: 220, editor: { type: 'text' } },
          {
            field: 'category_Id', title: '分类', width: 120, editor: { type: 'numberbox' }, formatter: function (value, row, index) {
              return '分类' + value;
            }
          },
          {
            field: 'action', title: '操作', width: 120, formatter: function (value, row, index) {
              // 如图是编辑状态，那么返回： 保存和取消
              // 如果是视图状态：返回  编辑和删除的按钮
              var html = "";
              if (row.isEditing) {
                html += '<a href="javascript:" onclick="saveRow(' + index + ')">保存</a>'
                html += '&nbsp;&nbsp;&nbsp;';
                html += '<a href="javascript:" onclick="cancelEdit(' + index + ')">取消</a>'
              } else {
                html += '<a href="javascript:" onclick="editRow(' + index + ')">修改</a>'
                html += '&nbsp;&nbsp;&nbsp;';
                html += '<a href="javascript:" onclick="delRow(' + index + ')">删除</a>'
              }
              return html;
            }
          }
        ]],
        toolbar: [{
          id: 'btnDownShelf',
          text: '添加',
          iconCls: 'icon-add',
          handler: function () {
            // 弹出一个添加的层
            $('.add-dialog').dialog({
              title: '添加课程信息',
              width: 300,
              height: 300,
              minimizable: true,
              collapsible: true,
              maximizable: true,
              resizable: true,
              modal: true,
              buttons: [{
                iconCls: 'icon-ok',
                text: '保存',
                handler: function () {
                  // 往后退保存数据，成功之后提示成功消息，并关闭对话框
                  var arrData = $('#frmAdd').serializeArray();
                  arrData.push({
                    name: 'id',
                    value: Date.now()
                  });

                  $.ajax({
                    url: '/api/course',
                    type: 'POST',
                    data: arrData,
                    dataType: 'json'
                  }).done(function (data) {
                    // 关闭对话框
                    $('#frmAdd')[0].reset();
                    $('.add-dialog').dialog('close');
                    // 刷新表格
                    $('#coursett').datagrid('reload');
                    // 提醒用户添加成功！
                    $.messager.show({
                      title: '添加提醒',
                      msg: '添加成功！',
                      timeout: 1000
                    });
                  }).fail(function () {
                    $.messager.alert('添加消息', '添加失败，请重试！', 'warning');
                  });
                }
              }, {
                text: '关闭',
                iconCls: 'icon-no',
                handler: function () {
                  $.messager.confirm('提醒', '您确实要取消添加课程信息吗？', function (r) {
                    if (!r) {
                      return;
                    }
                    // 清空添加的表单，另外关闭对话框
                    $('#frmAdd')[0].reset();
                    $('.add-dialog').dialog('close');
                  });
                }
              }]
            });
          }
        }, {
          id: 'clearAllSelect',
          text: '清除选择',
          iconCls: 'icon-redo',
          handler: function () {
            $('#coursett').datagrid('clearSelections');
          }
        },
        {
          id: 'btnDelete',
          text: '删除',
          iconCls: 'icon-cancel',
          handler: function () {
            //delRow(index);
            var row = $('#coursett').datagrid('getSelected');
            if (row) {
              var delIndex = $('#coursett').datagrid('getRowIndex', row);
              delRow(delIndex);
            } else {
              $.messager.alert('提醒消息', '请选择后再删除！', 'warning')
            }
          }
        }, {
          id: 'btnEdit',
          text: '修改',
          iconCls: 'icon-edit',
          handler: function () {
          }
        }],
        onHeaderContextMenu: function (e, field) {

        }
      });

      // 初始化分页器
      var pager = $('#coursett').datagrid('getPager');
      pager.pagination({
        layout: ['list', 'sep', 'first', 'prev', 'sep', 'links', 'sep', 'next', 'last', 'refresh', 'last']
      });
    }

    function editRow(rowIndex) {
      $('#coursett').datagrid('beginEdit', rowIndex);
      // 修改当前行的isEditing ==> true

      // 刷新当前行数据，
    }

    // 取消编辑
    function cancelEdit(rowIndex) {
      $('#coursett').datagrid('cancelEdit', rowIndex);
    }

    // 删除数据
    function delRow(rowIndex) {
      var rowData = $('#coursett').datagrid('getRows')[rowIndex];
      // 第一步：提升用户是否真删除
      $.messager.confirm({
        title: '确认消息',
        msg: '您确认要删除吗？',
        fn: function (r) {
          if (!r) {
            return;
          }
          // 用户进行删除操作
          $.ajax({
            url: '/api/course/' + rowData.id,
            type: 'DELETE',
            dataType: 'json'
          }).done(function (data) {
            // 把表格的数据重新加载一下
            $('#coursett').datagrid('reload');
          }).fail(function () {
            $.messager.alert('删除消息', '删除失败，请重试！', 'warning');
          });
        }
      });
    }

    // 保存当前编辑的行的数据
    function saveRow(rowIndex) {
      var originRowData = $('#coursett').datagrid('getRows')[rowIndex];

      // jQuery的extend方法  Object.assign方法相似
      originRowData = $.extend({}, originRowData);

      // 拿到修改完的数据
      $('#coursett').datagrid('endEdit', rowIndex);  // 结束编辑
      var rowData = $('#coursett').datagrid('getRows')[rowIndex];

      $('#coursett').datagrid('beginEdit', rowIndex);  // 结束编辑
      rowData.isEditing = "";
      // 发送ajax请求
      $.ajax({
        url: '/api/course/' + rowData.id,
        data: rowData,
        type: 'PUT',
        dataType: 'json'
      }).done(function (data) {
        // 提示成功或失败
        $.messager.show({
          title: '提示消息',
          msg: '修改成功！',
          timeout: 1000
        });
        // 结束当前行的编辑状态
        $('#coursett').datagrid('endEdit', rowIndex);  // 结束编辑
      }).fail(function (xhr, status, errromsg) {
        $.messager.show({
          title: '提示消息',
          msg: '修改失败了！',
          timeout: 1000
        });

        // 点击取消的时候，要把数据还原到之前的状态。
        $.extend(rowData, originRowData);
      });
    }
  </script>
</body>

</html>