<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <!-- 引入easyui的css 和js -->
  <link rel="stylesheet" href="./lib/jquery-easyui-1.5.5.2/themes/bootstrap/easyui.css">
  <link rel="stylesheet" href="./lib/jquery-easyui-1.5.5.2/themes/icon.css">

  <!-- jquyer -->
  <script src="./lib/jquery-easyui-1.5.5.2/jquery.min.js"></script>
  <!-- easyui的全部脚本 -->
  <script src="./lib/jquery-easyui-1.5.5.2/jquery.easyui.min.js"></script>
  <!-- 语言包 -->
  <script src="./lib/jquery-easyui-1.5.5.2/locale/easyui-lang-zh_CN.js"></script>
  <title>课程列表的crud</title>
</head>

<body>
  <table id="coursett"></table>
  <script>
    $(function () {
      // 加载表格的数据
      initTable();
    });

    // 加载表格的数据
    function initTable() {
      $('#coursett').datagrid({
        // url: '/api/course',//rows:一页有多少条，page：请求当前页
        title: '课程列表',
        fit: true,
        fitColumns: true,
        method: 'GET',  // http请求的方法
        idField: 'id',  // 主键
        loadMsg: '正在加载用户的信息...',
        pagination: true, // 是否用分页控件
        singleSelect: true, // 是否是单行选中
        pageSize: 10,  // 默认一页多少条
        pageNumber: 1, // 默认显示第几页
        pageList: [10, 20, 30],
        queryParams: null,//让表格在加载数据的时候，额外传输的数据。
        onBeforeLoad: function (param) {  // 表格控件请求之前，可以设置相关参数。
          // param = {page: 1, rows: 10}
          param._page = param.page;
          param._limit = param.rows;
          param._sort = 'id';
          param._order = 'desc';
        },
        loader: function (param, successfn, errorfn) {
          $.ajax({
            url: '/api/course',
            data: param,  // 恩国际 _page 和_limit  
            type: 'GET',
            dataType: 'json',
            success: function (resData, status, xhr) {
              var total = parseInt(xhr.getResponseHeader('X-Total-Count'));
              var datagridData = { rows: resData.data, total: total };
              successfn(datagridData);
            },
            error: errorfn
          });
        },
        onLoadSuccess: function (data) {  // 后台请求成功之后，自动调用次方法
          console.log(data);
        },
        onDblClickRow: function (rowIndex, rowData) {
          // $.messager.alert('消息', rowData.id + '', 'info');
          $('#coursett').datagrid('beginEdit', rowIndex);
        },
        onBeforeEdit: function (rowIndex, rowData) {
          // 当表格进行编辑的时候，自动执行的事件
          rowData.isEditing = true; // 把当前行的数据修改
          $('#coursett').datagrid('refreshRow', rowIndex);
        }, onCancelEdit: function (rowIndex, rowData) {
          rowData.isEditing = false; // 把当前行的数据修改
          $('#coursett').datagrid('refreshRow', rowIndex);
        }, onEndEdit: function (rowIndex, rowData, changes) {
          rowData.isEditing = false; // 把当前行的数据修改
          $('#coursett').datagrid('refreshRow', rowIndex);
        },
        columns: [[
          { field: 'ck', checkbox: true, align: 'left', width: 50 },
          { field: 'id', title: '编号', width: 80 },
          { field: 'course_name', title: '课程名', width: 120, editor: { type: 'text', options: { required: true } } },
          { field: 'author', title: '作者', width: 120, editor: { type: 'text' } },
          { field: 'college', title: '大学', width: 220, editor: { type: 'text' } },
          {
            field: 'category_Id', title: '分类', width: 120, editor: { type: 'numberbox' }, formatter: function (value, row, index) {
              return '分类' + value;
            }
          },
          {
            field: 'action', title: '操作', width: 120, formatter: function (value, row, index) {
              // 如图是编辑状态，那么返回： 保存和取消
              // 如果是视图状态：返回  编辑和删除的按钮
              var html = "";
              if (row.isEditing) {
                html += '<a href="javascript:" onclick="saveRow(' + index + ')">保存</a>'
                html += '&nbsp;&nbsp;&nbsp;';
                html += '<a href="javascript:" onclick="cancelEdit(' + index + ')">取消</a>'
              } else {
                html += '<a href="javascript:" onclick="editRow(' + index + ')">修改</a>'
                html += '&nbsp;&nbsp;&nbsp;';
                html += '<a href="javascript:" onclick="delRow(' + index + ')">删除</a>'
              }
              return html;
            }
          }
        ]],
        toolbar: [{
          id: 'btnDownShelf',
          text: '添加',
          iconCls: 'icon-add',
          handler: function () {

          }
        }, {
          id: 'clearAllSelect',
          text: '清除选择',
          iconCls: 'icon-redo',
          handler: function () {
            $('#coursett').datagrid('clearSelections');
          }
        },
        {
          id: 'btnDelete',
          text: '删除',
          iconCls: 'icon-cancel',
          handler: function () {
            //delRow(index);
            var row = $('#coursett').datagrid('getSelected');
            if (row) {
              var delIndex = $('#coursett').datagrid('getRowIndex', row);
              delRow(delIndex);
            } else {
              $.messager.alert('提醒消息', '请选择后再删除！', 'warning')
            }
          }
        }, {
          id: 'btnEdit',
          text: '修改',
          iconCls: 'icon-edit',
          handler: function () {
          }
        }],
        onHeaderContextMenu: function (e, field) {

        },
        onLoadSuccess: function (data) {

        }
      });

      // 初始化分页器
      var pager = $('#coursett').datagrid('getPager');
      pager.pagination({
        layout: ['list', 'sep', 'first', 'prev', 'sep', 'links', 'sep', 'next', 'last', 'refresh', 'last']
      });
    }

    function editRow(rowIndex) {
      $('#coursett').datagrid('beginEdit', rowIndex);
      // 修改当前行的isEditing ==> true

      // 刷新当前行数据，
    }

    // 取消编辑
    function cancelEdit(rowIndex) {
      $('#coursett').datagrid('cancelEdit', rowIndex);
    }

    // 删除数据
    function delRow(rowIndex) {
      var rowData = $('#coursett').datagrid('getRows')[rowIndex];
      // 第一步：提升用户是否真删除
      $.messager.confirm({
        title: '确认消息',
        msg: '您确认要删除吗？',
        fn: function (r) {
          if (!r) {
            return;
          }
          // 用户进行删除操作
          $.ajax({
            url: '/api/course/' + rowData.id,
            type: 'DELETE',
            dataType: 'json'
          }).done(function (data) {
            // 把表格的数据重新加载一下
            $('#coursett').datagrid('reload');
          }).fail(function () {
            $.messager.alert('删除消息', '删除失败，请重试！', 'warning');
          });
        }
      });
    }

    // 保存当前编辑的行的数据
    function saveRow(rowIndex) {
      var originRowData = $('#coursett').datagrid('getRows')[rowIndex];

      // jQuery的extend方法  Object.assign方法相似
      originRowData = $.extend({}, originRowData);

      // 拿到修改完的数据
      $('#coursett').datagrid('endEdit', rowIndex);  // 结束编辑
      var rowData = $('#coursett').datagrid('getRows')[rowIndex];

      $('#coursett').datagrid('beginEdit', rowIndex);  // 结束编辑
      rowData.isEditing = "";
      // 发送ajax请求
      $.ajax({
        url: '/api/course/' + rowData.id,
        data: rowData,
        type: 'PUT',
        dataType: 'json'
      }).done(function (data) {
        // 提示成功或失败
        $.messager.show({
          title: '提示消息',
          msg: '修改成功！',
          timeout: 1000
        });
        // 结束当前行的编辑状态
        $('#coursett').datagrid('endEdit', rowIndex);  // 结束编辑
      }).fail(function (xhr, status, errromsg) {
        $.messager.show({
          title: '提示消息',
          msg: '修改失败了！',
          timeout: 1000
        });

        // 点击取消的时候，要把数据还原到之前的状态。
        $.extend(rowData, originRowData);
      });
    }
  </script>
</body>

</html>